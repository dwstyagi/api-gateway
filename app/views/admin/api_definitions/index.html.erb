<% content_for :page_title, 'API Definitions - Routing Control' %>

<div class="max-w-7xl mx-auto">
  <%# Header with Create Button %>
  <div class="flex items-center justify-between mb-6">
    <div>
      <h1 class="text-2xl font-bold text-gray-900">API Definitions</h1>
      <p class="text-sm text-gray-600 mt-1">Manage backend service routing</p>
    </div>
    <%= link_to new_admin_api_definition_path, class: 'btn btn-primary' do %>
      <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
      </svg>
      Create API
    <% end %>
  </div>

  <%# API Definitions Table %>
  <div class="card bg-white shadow-xl">
    <div class="card-body">
      <% if @api_definitions.any? %>
        <div class="overflow-x-auto">
          <table class="table table-zebra">
            <thead>
              <tr>
                <th>Name</th>
                <th>Route Pattern</th>
                <th>Backend URL</th>
                <th>Methods</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              <% @api_definitions.each do |api| %>
                <tr class="hover">
                  <td class="font-bold text-gray-900"><%= api.name %></td>
                  <td class="font-mono text-sm"><%= api.route_pattern %></td>
                  <td class="font-mono text-sm text-blue-600 truncate max-w-xs">
                    <%= api.backend_url %>
                  </td>
                  <td>
                    <div class="flex gap-1">
                      <% api.allowed_methods.each do |method| %>
                        <span class="badge badge-sm badge-outline"><%= method %></span>
                      <% end %>
                    </div>
                  </td>
                  <td>
                    <%= status_badge(api.enabled ? 'enabled' : 'disabled') %>
                  </td>
                  <td>
                    <div class="flex gap-2">
                      <%# Toggle Enable/Disable - WITH CONFIRMATION %>
                      <% if api.enabled %>
                        <button onclick="showDisableConfirmation('<%= api.id %>', '<%= api.name %>')"
                                class="btn btn-sm btn-error">
                          Disable
                        </button>
                      <% else %>
                        <%= button_to 'Enable',
                            admin_api_definition_toggle_path(api),
                            method: :post,
                            class: 'btn btn-sm btn-success',
                            data: { turbo_confirm: "Enable API '#{api.name}'? Traffic will start routing immediately." } %>
                      <% end %>

                      <%# Edit Button %>
                      <%= link_to edit_admin_api_definition_path(api), class: 'btn btn-sm btn-ghost' do %>
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                        </svg>
                      <% end %>

                      <%# Delete Button %>
                      <%= button_to admin_api_definition_path(api),
                          method: :delete,
                          class: 'btn btn-sm btn-ghost text-red-600',
                          data: { turbo_confirm: "Delete API '#{api.name}'? This will remove all associated rate limit policies. This action cannot be undone." } do %>
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                        </svg>
                      <% end %>
                    </div>
                  </td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
      <% else %>
        <div class="text-center py-12">
          <svg class="w-16 h-16 text-gray-300 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 9l3 3-3 3m5 0h3M5 20h14a2 2 0 002-2V6a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
          </svg>
          <p class="text-gray-600 text-lg">No API definitions yet</p>
          <p class="text-gray-400 text-sm mt-2">Create your first API definition to start routing traffic</p>
          <%= link_to 'Create API Definition', new_admin_api_definition_path, class: 'btn btn-primary mt-4' %>
        </div>
      <% end %>
    </div>
  </div>
</div>

<%# DISABLE CONFIRMATION MODAL WITH BLAST RADIUS %>
<dialog id="disable-api-modal" class="modal">
  <div class="modal-box max-w-2xl">
    <h3 class="font-bold text-lg text-red-700 mb-4">
      ⚠️ Disable API: <span id="api-name-display"></span>?
    </h3>

    <%# Blast Radius Preview (populated by JavaScript) %>
    <div class="alert alert-error mb-4">
      <div>
        <h4 class="font-bold text-lg mb-2">BLAST RADIUS:</h4>
        <ul class="list-disc ml-6 space-y-1" id="blast-radius-list">
          <li id="blast-users">Calculating...</li>
          <li id="blast-keys">Calculating...</li>
          <li id="blast-requests">Calculating...</li>
        </ul>
      </div>
    </div>

    <div class="alert alert-warning mb-4">
      <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
      </svg>
      <span><strong>This will happen IMMEDIATELY.</strong></span>
    </div>

    <%# Type to Confirm %>
    <div class="form-control mb-4">
      <label class="label">
        <span class="label-text font-bold">Type API name "<span id="api-name-confirm"></span>" to confirm:</span>
      </label>
      <input type="text"
             id="confirm-api-name-input"
             class="input input-bordered"
             placeholder="Type API name here">
    </div>

    <div class="modal-action">
      <button class="btn btn-ghost" onclick="document.getElementById('disable-api-modal').close()">
        Cancel
      </button>
      <%= button_to 'Confirm Disable',
          '#',
          method: :post,
          id: 'confirm-disable-btn',
          class: 'btn btn-error',
          disabled: true,
          data: { api_id: '' } %>
    </div>
  </div>
  <form method="dialog" class="modal-backdrop">
    <button>close</button>
  </form>
</dialog>

<%# JAVASCRIPT FOR BLAST RADIUS CALCULATION %>
<script>
  let currentApiId = null;
  let currentApiName = null;

  function showDisableConfirmation(apiId, apiName) {
    currentApiId = apiId;
    currentApiName = apiName;

    // Update modal text
    document.getElementById('api-name-display').textContent = apiName;
    document.getElementById('api-name-confirm').textContent = apiName;
    document.getElementById('confirm-api-name-input').value = '';
    document.getElementById('confirm-disable-btn').disabled = true;

    // Show modal
    document.getElementById('disable-api-modal').showModal();

    // Calculate blast radius (mocked for now - would call backend endpoint)
    calculateBlastRadius(apiId);
  }

  function calculateBlastRadius(apiId) {
    // For now, use mock data
    // In production, this would be: fetch(`/admin/api_definitions/${apiId}/blast_radius`)

    // Mock calculation
    setTimeout(() => {
      const mockData = {
        affected_users: Math.floor(Math.random() * 200) + 10,
        active_keys: Math.floor(Math.random() * 50) + 5,
        requests_per_hour: Math.floor(Math.random() * 5000) + 100
      };

      document.getElementById('blast-users').innerHTML =
        `<strong>${mockData.affected_users}</strong> users will be affected`;
      document.getElementById('blast-keys').innerHTML =
        `<strong>${mockData.active_keys}</strong> active API keys will fail`;
      document.getElementById('blast-requests').innerHTML =
        `<strong>${mockData.requests_per_hour}</strong> requests/hour will be blocked`;
    }, 500);
  }

  // Enable confirm button when user types correct API name
  document.getElementById('confirm-api-name-input')?.addEventListener('input', (e) => {
    const confirmBtn = document.getElementById('confirm-disable-btn');
    const typedName = e.target.value.trim();

    if (typedName === currentApiName) {
      confirmBtn.disabled = false;
      confirmBtn.dataset.apiId = currentApiId;

      // Update form action
      confirmBtn.form.action = `/admin/api_definitions/${currentApiId}/toggle`;
    } else {
      confirmBtn.disabled = true;
    }
  });

  // Handle successful disable
  document.getElementById('confirm-disable-btn')?.addEventListener('click', () => {
    // Form will submit, modal will close on turbo response
    setTimeout(() => {
      document.getElementById('disable-api-modal').close();
    }, 100);
  });
</script>

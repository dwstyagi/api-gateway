<!DOCTYPE html>
<html class="h-full bg-gray-50">
  <head>
    <title>Admin Console - <%= content_for(:title) || "API Gateway" %></title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <%= csrf_meta_tags %>
    <%= csp_meta_tag %>

    <%= stylesheet_link_tag :app, "data-turbo-track": "reload" %>
    <%= stylesheet_link_tag "tailwind", "data-turbo-track": "reload" %>

    <%# Chartkick for charts %>
    <script src="https://www.gstatic.com/charts/loader.js"></script>
    <%= javascript_include_tag "chartkick", "data-turbo-track": "reload" %>

    <%# Action Cable for WebSockets %>
    <%= javascript_include_tag "actioncable", "data-turbo-track": "reload" %>

    <style>
      /* Safety-first styling - NO gradients, NO animations except critical alerts */
      body.admin-layout {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      }

      /* Critical alert flash (RED border) */
      @keyframes criticalFlash {
        0%, 100% { border-color: transparent; }
        50% { border-color: #DC2626; }
      }

      .critical-flash {
        animation: criticalFlash 2s ease-in-out;
        border: 4px solid transparent;
      }

      /* Force white backgrounds on all form inputs */
      input[type="text"],
      input[type="email"],
      input[type="password"],
      input[type="number"],
      input[type="date"],
      textarea,
      select {
        background-color: white !important;
        color: #1f2937 !important;
      }

      /* Fix autofill colors */
      input:-webkit-autofill,
      input:-webkit-autofill:hover,
      input:-webkit-autofill:focus,
      input:-webkit-autofill:active {
        -webkit-box-shadow: 0 0 0 30px white inset !important;
        -webkit-text-fill-color: #1f2937 !important;
      }

      /* Countdown timer highlighting */
      .countdown-timer.text-red-600 {
        font-weight: bold;
        animation: pulse 1s infinite;
      }

      @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.7; }
      }
    </style>
  </head>

  <body class="h-full admin-layout">
    <div class="flex h-full">
      <%# Fixed Sidebar %>
      <%= render 'admin/shared/sidebar' %>

      <%# Main Content Area %>
      <main class="flex-1 overflow-y-auto bg-gray-50">
        <%# Top Bar %>
        <div class="bg-white border-b border-gray-200 sticky top-0 z-10">
          <div class="px-6 py-4">
            <div class="flex items-center justify-between">
              <div class="flex items-center space-x-4">
                <h1 class="text-xl font-semibold text-gray-900">
                  <%= content_for(:page_title) || 'Admin Console' %>
                </h1>

                <%# Connection Status Indicators %>
                <div class="flex items-center space-x-3">
                  <div class="flex items-center" id="redis-status-indicator">
                    <div class="w-2 h-2 rounded-full bg-green-500 mr-2"></div>
                    <span class="text-xs text-gray-600">Redis</span>
                  </div>
                  <div class="flex items-center" id="db-status-indicator">
                    <div class="w-2 h-2 rounded-full bg-green-500 mr-2"></div>
                    <span class="text-xs text-gray-600">Database</span>
                  </div>
                </div>
              </div>

              <div class="flex items-center space-x-4">
                <%# WebSocket Connection Status %>
                <div id="ws-connection-status">
                  <span class="text-gray-400 text-xs">‚óè Connecting...</span>
                </div>

                <span class="text-sm text-gray-600">
                  <%= current_user.email %>
                </span>
                <%= link_to logout_path, method: :delete, data: { turbo_method: :delete },
                    class: 'btn btn-ghost btn-sm' do %>
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                  </svg>
                  Logout
                <% end %>
              </div>
            </div>
          </div>
        </div>

        <%# Flash Messages %>
        <% if flash.any? %>
          <div class="px-6 py-4">
            <% flash.each do |type, message| %>
              <div class="alert <%= type == 'notice' ? 'alert-success' : 'alert-error' %> mb-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <span><%= message %></span>
              </div>
            <% end %>
          </div>
        <% end %>

        <%# Page Content %>
        <div class="px-6 py-6">
          <%= yield %>
        </div>
      </main>
    </div>

    <%# Real-time Alert Notifications Container %>
    <div id="admin-alerts" class="fixed top-20 right-6 z-50 max-w-md space-y-2"></div>

    <%# Include admin real-time JavaScript %>
    <%= javascript_include_tag "admin_realtime", "data-turbo-track": "reload" %>

    <%# Admin WebSocket Connection Script %>
    <script>
      // Simple connection status checker (no fancy WebSocket for now)
      function checkConnectionStatus() {
        fetch('/health/detailed', { method: 'GET' })
          .then(res => res.json())
          .then(data => {
            // Update Redis indicator
            const redisIndicator = document.getElementById('redis-status-indicator')?.querySelector('.w-2');
            if (redisIndicator) {
              redisIndicator.className = data.redis?.status === 'healthy'
                ? 'w-2 h-2 rounded-full bg-green-500 mr-2'
                : 'w-2 h-2 rounded-full bg-red-600 mr-2';
            }

            // Update DB indicator
            const dbIndicator = document.getElementById('db-status-indicator')?.querySelector('.w-2');
            if (dbIndicator) {
              dbIndicator.className = data.database?.status === 'healthy'
                ? 'w-2 h-2 rounded-full bg-green-500 mr-2'
                : 'w-2 h-2 rounded-full bg-red-600 mr-2';
            }
          })
          .catch(err => {
            console.error('Health check failed:', err);
          });
      }

      // Check every 10 seconds
      setInterval(checkConnectionStatus, 10000);

      // Check on page load
      document.addEventListener('DOMContentLoaded', checkConnectionStatus);
    </script>
  </body>
</html>
